---
title: ggplot2 basics
layout: default
output: bookdown::html_chapter
---

# Chapter 2: data visualization using ggplot2

This chapter presents ggplot2, an implementation of the multi-layer,
multi-panel grammer of graphics.

Chapter outline:

* Brief history of the grammar of graphics
* Rendering a basic ggplot using animint
* Multi-layer ggplots
* Multi-panel ggplots

## Brief history of the grammar of graphics

Wilkinson proposed a general grammar of graphics to describe and
create a large class of static data visualizations
[Wilkinson 2006]. Wickham implemented several ideas from that grammar
in the ggplot2 R package [Wickham 2009]. Wilkinson's grammar describes
*static* graphics, which can be viewed equally well on a
computer screen or on paper.

The main topic of this book is animint, an R package for
*interactive* graphics. In contrast to static graphics,
interactive graphics are best viewed on a computer with a mouse and
keyboard that can be used to interact with the plot. Since many
concepts from static graphics are also useful for interactive graphics
(e.g. legends), the animint package is implemented as an extension of
ggplot2. In this chapter we will introduce the main features of
ggplot2 which will also be useful for interactive plot design in later
chapters.

## Rendering a basic ggplot using animint

The R code below produces a scatterplot of life expectancy and
fertility rate for each country in the WorldBank data set.

```{r}
data(WorldBank, package="animint")
library(ggplot2)
WorldBank1975 <- subset(WorldBank, year==1975)
basic <- ggplot()+
  geom_point(aes(x=life.expectancy, y=fertility.rate, color=region),
             data=WorldBank1975)
basic
```

This ggplot contain exactly one *layer*, a `geom_point` which displays
a circle for every row the in data set specified. The `aes` specifies
the mapping of data variables to visual properties. The `x` and `y`
properties are used for the horizontal and vertical position, and the
`color` property specifies the color each point.

This ggplot can be rendered with animint, by first assigning the
ggplot to a named element of a list, and then giving that list the
class `"animint"`.

```{r}
library(animint)
basic.viz <- list(scatter=basic)
structure(basic.viz, class="animint")
```

The first line loads the animint package, the second line assigns the
ggplot `basic` to a named element of the `basic.viz` list, and the
third line gives the list the class `"animint"`. When executing this
code on the R command line, R will run the `print.animint` function
via the S3 object system
[http://adv-r.had.co.nz/OO-essentials.html#s3]. That will run the
`animint2dir` function, which converts the animint `basic.viz` list to
a directory of data and code files that can be rendered in a web
browser.

When viewed in a web browser, the plot should look mostly the same as
the version in R. One difference is that the region legend is
interactive: clicking a legend entry will hide or show the points of
that color.

## Manual color legends

The colors that are used in the legend can be manually specified via
`scale_color_manual`. Typically we will choose one of the ColorBrewer
palettes:

```{r, fig.height=8}
RColorBrewer::display.brewer.all()
```

For example to get the R code for the Set1 palette, we can write

```{r}
dput(RColorBrewer::brewer.pal(Inf, "Set1"))
```

We can then copy that R code from the terminal and paste it into our
text editor

```{r}
region.colors <- 
  c("#E41A1C", "#377EB8", "#4DAF4A", "#984EA3", "#FF7F00", "#FFFF33", 
    "#A65628", "#F781BF", "#999999")
names(region.colors) <- levels(WorldBank$region)
region.colors
```

Then we can use it with `scale_color_manual` 

```{r}
ggplot()+
  scale_color_manual(values=region.colors)+
  geom_point(aes(x=life.expectancy, y=fertility.rate, color=region),
             data=WorldBank1975)
```

TODO: move this to an appendix.

## Multi-layer data visualization (multiple geoms)

Multi-layer data visualization is useful when you want to display
several different data sets in the same plot. For example, consider
the following R code which adds a `geom_path` to the previous data
visualization.

```{r}
WorldBankBefore1975 <- subset(WorldBank, 1970 <= year & year <= 1975)
two.layers <- basic+
  geom_path(aes(x=life.expectancy, y=fertility.rate, color=region,
                group=country),
            data=WorldBankBefore1975)
two.layer.viz <- list(scatter=two.layers)
structure(two.layer.viz, class="animint")
```

This plot shows a data visualization with 2 geoms/layers: 

* the `geom_point` shows the life expectancy, fertility rate, and
  region of all countries in 1975.
* the `geom_path` shows the same variables for the previous 5 years.

The addition of the `geom_path` shows how the countries changed over
time. In particular, it shows that most countries moved to the right
and down, meaning higher life expectancy and lower fertility
rate. However, there are some exceptions. For example, the two East
Asian countries in the bottom left suffered a decrease in life
expectancy over this period. And there are some countries which showed
an increased fertility rate. Can we add the names of these countries
to this data viz? Below, we add another layer with a text label for
each country's name.

```{r}
three.layers <- two.layers+
  geom_text(aes(x=life.expectancy, y=fertility.rate, color=region,
                label=country),
            data=WorldBank1975)
three.layer.viz <- list(scatter=three.layers)
structure(three.layer.viz, class="animint")
```

This data viz is not so easy to read, since there are so many
overlapping text labels. The interactive region legend helps a little,
by allowing the user to hide data from selected regions. However, it
would be even better if the user could show and hide the text for
individual countries. That type of interaction can be achieved using
the showSelected and clickSelects aesthetics which we explain in
Chapters 3-4.

For now, we move on to discuss the other main advantage of ggplot2:
facets.

## Multi-panel data visualization (facets)

Panels or facets are sub-plots that show related data
visualizations. One of the main strengths of ggplot2 is that different
kinds of multi-panel plots are relatively easy to create. Multi-panel
data visualization is used in two different ways:

* You want to align the axes of several related plots containing
  different geoms. This facilitates comparison between several
  different geoms, and is a technique that is also useful for
  interactive data visualization.
* You want to divide the data from one geom into several panels. This
  facilitates comparison between data subsets, and is less useful for
  interactive data visualization (interactivity can often be used
  instead, to achieve the same effect of comparing data subsets).

  
### Different geoms in each panel (aligned axes)
  
Facets are useful to align the axes of related plots. For example,
consider the following data visualization which consists of two plots:
a scatterplot with data from 1975, and a time series with data from
1960-2010.
  
```{r}
viz.two.plots <- two.layer.viz
viz.two.plots$timeSeries <- ggplot()+
  geom_line(aes(x=year, y=fertility.rate, color=region, group=country),
            data=WorldBank)
structure(viz.two.plots, class="animint")
```

The data visualization above contains two ggplots. Both ggplots map
the fertility rate variable to the y axis. However, since they are
separate plots, the ranges of their y axes are computed
separately. That means that the two y axis are not exactly
aligned. That is a problem since it would make it easier to decode the
data visualization if each unit of vertical space was used to show the
same amount of fertility rate. To achieve that effect, we use facets
in the data visualization below.

```{r}
addColumn <- function(df, time.period){
  data.frame(df, time.period=factor(time.period, c("1975", "1960-2010")))
}
viz.aligned <- list(
  scatter=ggplot()+
    geom_point(aes(x=life.expectancy, y=fertility.rate, color=region),
               data=addColumn(WorldBank1975, "1975"))+
    geom_path(aes(x=life.expectancy, y=fertility.rate, color=region,
                  group=country),
              data=addColumn(WorldBankBefore1975, "1975"))+
    geom_line(aes(x=year, y=fertility.rate, color=region, group=country),
              data=addColumn(WorldBank, "1960-2010"))+
    facet_grid(. ~ time.period, scales="free")
  )
structure(viz.aligned, class="animint")
```

The data visualization above contains a single ggplot with two panels
and three layers. The left panel shows the `geom_point` and
`geom_path`, and the right panel shows the `geom_line`. The panels
have a shared axis for fertility rate, which ensures that the time
series can be directly compared with the scatterplot.

Note that we used the `addColumn` function to add a `time.period`
variable to each data set, and then we used that variable in
`facet_grid(scales="free")`. We call this the "addColumn-then-facet"
idiom, which is useful in general for creating a multi-panel data
visualization with aligned axes (TODO:ref appendix). In particular, if
we wanted to change the order of the panels in the data visualization,
we would only need to edit the order of the factor levels in the
definition of `addColumn`.

### Same geoms in each panel (compare data subsets)

The second reason for using plots with multiple panels in a data
visualization is to compare subsets of observations. This facilitates
comparison between data subsets, and can be used in at least two
different situations

* One geom's data set has too many observations to display
  informatively in one panel.
* You want to compare different subsets of data that is plotted for
  one geom.
  
For example, the code below creates two data sets based on three years
of the WorldBank data set. 

```{r}
show.point.list <- list()
show.path.list <- list()
for(show.year in c(1975, 1985, 1995)){
  show.point.list[[paste(show.year)]] <- data.frame(
    show.year, subset(WorldBank, year==show.year))
  five.before <- show.year - 5
  show.path.list[[paste(show.year)]] <- data.frame(
    show.year, subset(WorldBank, five.before <= year & year <= show.year))
}
show.point <- do.call(rbind, show.point.list)
show.path <- do.call(rbind, show.path.list)
```

We used a for loop over three values of `show.year`, the variable
which we will use later in `facet_grid`. For each value of
`show.year`, we store a data subset as a named element of a
list. After the for loop, we use `do.call` with `rbind` to combine the
data subsets. This is an example of the "list-of-data-tables" idiom,
which is also useful for interactive data visualization (TODO: ref
appendix).

Below, we facet on the `show.year` variable to create a data
visualization with three panels.

```{r}
viz.panels <- list(
  scatter=ggplot()+
    geom_point(aes(x=life.expectancy, y=fertility.rate, color=region),
               data=show.point)+
    geom_path(aes(x=life.expectancy, y=fertility.rate, color=region,
                  group=country),
              data=show.path)+
    facet_grid(. ~ show.year)
  )
structure(viz.panels, class="animint")
```

The data visualization above contains a single ggplot with three
panels. It shows more of the WorldBank data set than the previous
single-panel visualization with data only from 1975. However, it still
only shows a small subset of these data (from 1975, 1985, and
1995). 

You may be tempted to try using a panel to display every year (not
just 1975, 1985, and 1995). However, beware that this type of
multi-panel data visualization is especially useful if there are only
a few data subsets. With more than about 10 panels, it becomes
difficult to see all the data at once, and thus difficult to make
meaningful comparisons.

In the next chapter, we will show how the new `showSelected` keyword
can be used to achieve animation, and show more of this data set.

## Chapter summary and exercises

This chapter presented the basics of static data visualization using
ggplot2. We showed how animint can be used to render a list of ggplots
in a web browser. We explained two features of ggplot2 that make it
ideal for data visualization: multi-layer and multi-panel graphics.

Exercises:

* What is the purpose of multi-layer graphics?
* What are the two different reasons for creating multi-panel
  graphics? Which of these two types is useful with interactivity?
* Let us define "A < B" to mean that "B can contain several A." Which
  of the following statements is true?

	* ggplot < panel
	* panel < ggplot
	* ggplot < animint
	* animint < ggplot
	* layer < panel
	* panel < layer
	* layer < ggplot
	* ggplot < layer
	
* In the `viz.aligned` facets, why is it important to use the
  `scales="free"` argument?
* In `viz.aligned` we showed a ggplot with a scatterplot panel on the
  left and a time series panel on the right. Make another version of
  the data visualization with the time series panel on the left and
  the scatterplot panel on the right.
* In `viz.aligned` the scatterplot displays fertility rate and life
  expectancy, but the time series displays only fertility rate. Make
  another version of the data visualization that shows both time
  series. Hint: use both horizontal and vertical panels in
  `facet_grid`.
* Create a multi-panel data visualization that shows each year of the
  `WorldBank` data set in a separate panel. What are the limitations
  of using static graphics to visualize these data?
